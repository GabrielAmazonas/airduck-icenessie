# airduck-icenessie

<p align="center">
  <img src="logo.png" alt="Airduck-IceNessie Logo" width="300">
</p>

A modern data stack proposal for handling Embeddings on data laheouses. Unlocks the value of datasets generated by Vector Search & RAG (Retrieval-Augmented Generation) use cases, combining open-source data lakehouse technologies embedding models.

## Overview

This architecture demonstrates how to build a production-ready RAG system without proprietary vector databases:

- **DuckDB + VSS** for embedded vector search with optional HNSW indexing
- **Trino** as federated SQL query engine with vector search capability
- **Apache Iceberg + Nessie** for open table format and catalog on data lakehouse
- **dbt** for medallion architecture transformations (Bronze → Silver → Gold)
- **Apache Airflow** for orchestration
- **MinIO** as S3-compatible object storage

> For detailed architecture documentation, see [ARCHITECTURE.md](./ARCHITECTURE.md)

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            PRESENTATION LAYER                                │
│  ┌─────────────────┐     ┌─────────────────┐                                │
│  │   Next.js UI    │────▶│  FastAPI + RAG  │◀──── Vector Search API         │
│  │    (3000)       │     │     (8000)      │      /search, /search/iceberg  │
│  └─────────────────┘     └────────┬────────┘                                │
├────────────────────────────────────┼────────────────────────────────────────┤
│                         VECTOR SEARCH OPTIONS                                │
│            ┌───────────────────────┴───────────────────────┐                │
│            ▼                                               ▼                │
│  ┌─────────────────────────┐                 ┌─────────────────────────┐   │
│  │     DuckDB (EFS)        │                 │    Trino → Iceberg      │   │
│  │  • Brute force (default)│                 │  • Query Gold layer     │   │
│  │  • HNSW index (optional)│                 │  • Cosine similarity    │   │
│  │  • Real-time indexing   │                 │  • Scales with workers  │   │
│  └─────────────────────────┘                 └─────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────────────┤
│                            ORCHESTRATION                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         Apache Airflow                                 │  │
│  │  • daily_reindex (HNSW)    • embed_iceberg_gold    • dbt transforms   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                            DATA LAKEHOUSE                                    │
│  ┌────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐   │
│  │     Trino      │──│     Nessie      │──│         MinIO (S3)          │   │
│  │    (8085)      │  │ Iceberg Catalog │  │  iceberg-warehouse/         │   │
│  │  dbt-trino     │  │    (19120)      │  │  rag-data/                  │   │
│  └────────────────┘  └─────────────────┘  └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Services

| Service | Port | Description |
|---------|------|-------------|
| Frontend | 3000 | Next.js search UI |
| FastAPI | 8000 | Vector search API with embedding generation |
| Airflow | 8080 | Workflow orchestrator |
| Trino | 8085 | Federated SQL query engine |
| Nessie | 19120 | Iceberg catalog with git-like versioning |
| MinIO | 9000/9001 | S3-compatible object storage |
| PostgreSQL | 5432 | Airflow metadata DB |

## Quick Start

### Prerequisites

- Docker & Docker Compose
- 8GB+ RAM recommended

### Running the Stack

```bash
# Start all services
docker compose up -d

# View logs
docker compose logs -f

# Stop all services
docker compose down
```

### Access Points

| Service | URL | Credentials |
|---------|-----|-------------|
| Frontend | http://localhost:3000 | - |
| API Docs | http://localhost:8000/docs | - |
| Airflow UI | http://localhost:8080 | `airflow` / `airflow` |
| Trino UI | http://localhost:8085 | - |
| Nessie UI | http://localhost:19120 | - |
| MinIO Console | http://localhost:9001 | `minioadmin` / `minioadmin` |

## Vector Search Endpoints

The system provides multiple search paths optimized for different use cases:

### `/search` - DuckDB Vector Search

```bash
# Brute-force cosine similarity (default)
curl -X POST http://localhost:8000/search \
  -H "Content-Type: application/json" \
  -d '{"query": "vector databases", "top_k": 5}'

# HNSW-accelerated search (requires daily_reindex DAG)
curl -X POST http://localhost:8000/search \
  -H "Content-Type: application/json" \
  -d '{"query": "vector databases", "top_k": 5, "use_hnsw": true}'
```

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `query` | string | required | Search query text |
| `top_k` | int | 10 | Number of results |
| `use_vector` | bool | true | Use vector search (false = text search) |
| `use_hnsw` | bool | false | Use HNSW index for O(log n) performance |

### `/search/iceberg` - Trino/Iceberg Vector Search

Query embeddings directly from the Iceberg Gold layer via Trino:

```bash
curl -X POST http://localhost:8000/search/iceberg \
  -H "Content-Type: application/json" \
  -d '{"query": "vector databases", "top_k": 5}'
```

**Benefits:**
- Queries the data lakehouse directly (source of truth)
- Scales with Trino workers
- No separate index to maintain

**Requires:** `embed_iceberg_gold` DAG to have run

### Search Performance Comparison

| Endpoint | Method | Complexity | Best For |
|----------|--------|------------|----------|
| `/search` (default) | Brute force | O(n) | Real-time docs, <100k vectors |
| `/search?use_hnsw=true` | HNSW index | O(log n) | Large datasets, batch-indexed |
| `/search/iceberg` | Trino SQL | O(n) | Data lake queries, audit trail |

## API Endpoints

### Vector Search (FastAPI)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/health` | Health check |
| GET | `/status` | DuckDB index status |
| GET | `/iceberg/status` | Iceberg embedding coverage |
| POST | `/search` | DuckDB vector search (brute force or HNSW) |
| POST | `/search/iceberg` | Trino/Iceberg vector search |
| POST | `/search/s3` | Search directly on S3 parquet files |
| POST | `/index` | Index single document (auto-embeds) |
| POST | `/index/batch` | Batch index documents |
| POST | `/embed` | Generate embedding for text |
| DELETE | `/documents/{id}` | Delete document |
| DELETE | `/documents` | Clear all documents |

## Embedding Model

The system uses **`all-MiniLM-L6-v2`** for semantic embeddings:

| Metric | Value |
|--------|-------|
| Dimensions | 384 |
| Model size | ~22 MB |
| Container memory | ~370 MB |
| Inference | CPU-only (no GPU required) |

Embeddings are generated automatically when indexing documents via the API.

## Airflow DAGs

| DAG | Purpose | Schedule |
|-----|---------|----------|
| `dbt_seed_bronze_data` | Create Bronze table with sample data | Manual |
| `dbt_manual_transforms` | Run dbt Bronze → Silver → Gold + compaction | Daily 1 AM |
| `embed_iceberg_gold` | Generate embeddings for Gold layer + compaction | Manual |
| `daily_reindex` | Build DuckDB HNSW index + S3 backup | Daily 2 AM |
| `iceberg_maintenance` | Full table optimization (compaction, cleanup) | Daily 3 AM |

### Small Files Problem

The `iceberg_maintenance` DAG addresses the **small files problem** common in data lakes:

| Task | Purpose |
|------|---------|
| `compact_small_files` | Merge small files into 128MB target size |
| `expire_old_snapshots` | Remove snapshots older than 7 days |
| `remove_orphan_files` | Clean up unreferenced data files |

Compaction also runs automatically after dbt transforms and embedding generation.

## Data Pipeline

The system uses a **medallion architecture** for data quality:

```
Bronze (raw)  →  Silver (cleaned)  →  Gold (enriched)  →  Embeddings
     ↓                ↓                    ↓                  ↓
 Raw ingestion   Deduplicated        Chunked, scored    384-dim vectors
                 SHA256 hashed       ready for embedding
```

dbt transformations run on Trino, with Iceberg tables stored in MinIO.

## Project Structure

```
airduck-icenessie/
├── docker-compose.yml       # Service orchestration
├── ARCHITECTURE.md          # Detailed architecture docs
├── app/                     # FastAPI + DuckDB vector search
│   ├── main.py             # API endpoints + embedding
│   └── requirements.txt    # CPU-only PyTorch
├── airflow/                 # Workflow orchestrator
│   ├── dags/               # DAG definitions
│   │   ├── reindex_dag.py          # HNSW index builder
│   │   ├── embed_iceberg_dag.py    # Iceberg embeddings
│   │   └── dbt_transform_dag.py    # dbt transforms
│   └── dbt/                # dbt project
│       ├── models/
│       │   ├── bronze/     # Raw layer
│       │   ├── silver/     # Cleaned layer
│       │   └── gold/       # Enriched layer
│       └── profiles.yml    # Trino connection
├── frontend/                # Next.js UI
│   └── src/app/
├── trino/                   # Trino configuration
│   ├── catalog/            # Iceberg + Nessie config
│   └── etc/                # Server config
└── minio-data/              # Persistent S3 storage
```

## Development

### Local Development (without Docker)

#### FastAPI

```bash
cd app
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn main:app --reload
```

#### Frontend

```bash
cd frontend
npm install
npm run dev
```

## Configuration

Key environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `EMBEDDING_MODEL` | Sentence transformer model | `all-MiniLM-L6-v2` |
| `S3_ENDPOINT` | MinIO/S3 endpoint | `http://minio:9000` |
| `EFS_PATH` | Shared storage path | `/mnt/efs` |
| `TRINO_HOST` | Trino server host | `trino` |
| `NEXT_PUBLIC_API_URL` | API URL for frontend | `http://localhost:8000` |

## Data Persistence

| Data | Storage | Survives Restart? |
|------|---------|-------------------|
| DuckDB index | Docker volume (`airduck_efs`) | ✅ Yes |
| MinIO/S3 data | Bind mount (`./minio-data/`) | ✅ Yes |
| Iceberg tables | MinIO S3 | ✅ Yes |
| Airflow metadata | Docker volume (`airduck_postgres`) | ✅ Yes |
| Nessie catalog | In-memory (default) | ❌ Rebuilt on restart |

The `iceberg-init` container automatically recreates Iceberg schemas on startup.

## Further Reading

- [ARCHITECTURE.md](./ARCHITECTURE.md) - Detailed architecture and scaling guide
- [DuckDB VSS Extension](https://duckdb.org/docs/extensions/vss)
- [Apache Iceberg](https://iceberg.apache.org/)
- [Project Nessie](https://projectnessie.org/)
- [dbt-trino](https://github.com/starburstdata/dbt-trino)

## License

MIT
